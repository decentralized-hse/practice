# Домашнее задание 1

***Задание:*** What is the level of complexity of the git codebase? Compare it to small/medium databases, give a complexity budget for the project, explain where the effort was spent.

Для сравнения c ***Git*** мы выбрали 2 базы данных: ***LevelDB*** (маленькая) и ***SQLite*** (средняя)


## LOC

Сначала для каждого репозитория замерим метрику LOC (Lines Of Code), самую наивную метрику измерения оценки сложности кода. Замерять будет при помощи `cloc`, считатется только основной код. Таким образом мы получим метрику, отражающую размер кодовой базы.

**Таблица со значениями LOC для каждого из репозиториев:**

| Repo | LOC |
|---|---|
| Git | 588 390 |
| LevelDB | 21 207 |
| SQLite | 143 559 |

Далее отнормируем LOC на кол-во файлов с кодом (тоже вытягивается из `cloc`), данная метрика показывает модульность репозитория. Большое значение &rarr; монолитность, маленькое значение &rarr; модульность.

| Repo | LOC Normalized |
|---|---|
| Git | 259.32 |
| LevelDB | 160.66 |
| SQLite | 963.48 |


## CCN (Cyclomatic Complexity)

CCN - это показатель сложность логики функции.
В нашем случае для оценки сложности функций проекта хорошей метрикой будет AvgCCN по всему проекту, таким образом мы замерим среднюю сложность функции по проекту. Замерять его будем при помощи утилиты `lizard`

| Repo | AvgCCN |
|---|---|
| Git | 5.7 |
| LevelDB | 2.3 |
| SQLite | 7.3 |

## Архитектура

В этом блоке мы разобьем каждый из проектов на основные подсистемы, по которым распределена сложность.

### Git
- Object storage (blob/tree/commit)
- Packfiles
- Delta compression
- Index
- Refs
- Networking (fetch/push)
- Merge algorithms
- Rebase
- Garbage collection
- Hooks
- CLI plumbing vs porcelain

Проект представляет собой не просто систему контроля версий, а распределенную базу данных + набор алгоритмов над ней. Git обладает очень большой кодовой базой из-за того, что содержит большое количество самописных модулей, которые во многих проектах импортированы из готовых библиотек. Огромное количество самописного кода обеспечивают Git полную автономность и работу без внешних зависимостей.

### LevelDB
- MemTable
- WAL
- SSTables
- Compaction
- Bloom filters
- Block cache

Проект является именно движком хранилища, нет никакой sql обертки, обычное KV.

### SQLite
- SQL parser
- Query planner
- LSM-tree storage
- Transaction manager
- Pager
- Locking
- Virtual machine (bytecode interpreter)

SQLite - это полноценная реляционная СУБД.

Далее опираясь на компоненты я декомпозирую сложности реализации каждого из проектов:

| Тип сложности | Git | LevelDB | SQLite |
|---|---|---|---|
| Алгоритмическая | высокая | средняя | высокая |
| Парсинг | низкая | отсутствует | высокая |
| Сетевое взаимодействие | средняя | отсутствует | отсутствует |
| Конкурентность | ограниченная | средняя | средняя |
| ACID | нет | частично выполняется | полный |

Таким образом, если суммаризировать данный блок мы из общих соображений здравого смысла можем отсортировать по сложности проекты таким образом: ***LevelDB &rarr; Git &rarr; SQLite***.

Компоненты, на которые была "потрачена" основная сложность были изложены выше.

## Complexity Budget

Для подсчета complexity budget возьмём предположение, что средний разработчик пишет в неделю в среднем от 300 до 500 строк кода в зависимости от сложности кода, который попадает в main-ветку. Также мы знаем, что разработчики помимо чистого написания кода еще занимаются документацией, написанием тестов и прочими полезными активностями. Так что справедливой оценкой для оверхэд на все эти мероприятия с учетом написания кода будет 3-5x в зависимости опять же от сложности кода.

Исходя из данных предположений оценим complexity budget для каждого из проектов.

| Проект | LOC | Эффективный LOC (оценка) | Complexity Budget, разработчико-года |
|---|---|---|---|
| Git | 588 390 | 2 353 560 | ~ 113 |
| LevelDB | 21 207 | 63 621 | ~ 2.5 |
| SQLite | 143 559 | 717 795 | ~ 46 |


## Итоги

Таким образом, мы получили некоторый набор метрик и оценок, которые отражают как концептуальную сложность кодовой базы, так и сложность в объеме.

| Проект | LOC | LOC Normalized | AvgCCN | Complexity Budget, разработчико-года |
|---|---|---|---|---|
| Git | 588 390 | 259.32 | 5.7 | ~ 113 |
| LevelDB | 21 207 | 160.66 | 2.3 | ~ 2.5 |
| SQLite | 143 559 | 963.48 | 7.3 | ~ 46 |


Наиболее объективной метрикой для оценки и сравнения кодовых баз этих репозиториев будет Complexity Budget. Данная метрика по сути показывает, сколько необходимо ресурсов для воспроизведения данной кодовой базы.

Сложнее всего оказался Git из-за очень большой кодовой базы и алгоритмической сложности. На 2-ом месте оказался SQLite, потому что это полноценная реляционная СУБД, которая соответствует полностью ACID и содержит множество концептуально сложных компонентов, каждый из которых содержит большое количество кода. Последнее место занял LevelDB, поскольку это просто быстрое KV-хранище на основе b-дерева, не имеющее большой модульности и функционала.
