# Динамика данных vs строк (LOC) в файлах

Для отслеживания динамики данных и строк в файлах, была написана программа на Go, код которой лежит в [main.go](./main.go). В качестве примера использования программы был выбран репозиторий [skypilot-org/skypilot](https://github.com/skypilot-org/skypilot).

## 1. Постановка задачи

Оригинальный текст задачи:

    Track the dynamic of data changed vs lines changed in files, make stats (accumulation of loc-changed vs actual binary diff of first and last versions)

Какие данные нужно получить:

- **Accumulation of LOC-changed** - накопленная по всей истории сумма изменённых строк (добавлено + удалено) по каждому файлу.
- **Actual binary diff of first and last versions** - объём отличий между первой и последней версией разница размеров в байтах: `|size(HEAD) − size(root)|`.

Также посчитаем **net LOC** (дифф root -> HEAD в строках) и **ratio** = accum LOC / net LOC - соотношение изменений к изменённым строкам. Для устранения вырожденности "всё от нуля" добавлена **третья точка по середине истории** (коммит mid): считаются отдельно метрики root -> mid и mid -> HEAD.

**Пофайловая разница delta vs lines:** для каждого файла считаем, насколько построчный diff (net LOC) соотносится с реальным объёмом изменений в байтах (binary delta). Метрика **bytes/line** = binary delta / net LOC (байт на одну изменённую строку в диффе root -> HEAD) показывает это соотношение по файлам.

## 2. Сводные показатели

Статистика ниже получена запуском программы на репозитории skypilot. Результаты привязаны к следующим коммитам:

| Точка | Коммит | Дата | Описание |
|-------|--------|------|----------|
| **root** | `e8a7b8dea3ae` | 2021-08-24 | Корневой коммит (первый в истории) |
| **mid** | `9458ca20f392` | 2025-02-24 | Средний коммит по истории (root..HEAD) |
| **HEAD** | `0fcf3e8c1103` | 2026-02-09 | Коммит, относительно которого строилась статистика |

Все диффы и размеры в отчёте считаются между этими ревизиями (root, mid, HEAD).

### Сводная таблица (вывод программы)

| Показатель | Значение |
|------------|----------|
| Файлов в HEAD | 2 137 |
| **Total accumulated LOC changed** | 786 876 |
| **Total net LOC (root -> HEAD)** | 472 089 |
| **Overall accumulation ratio** | 1.67× |
| **Total binary delta (root -> HEAD)** | 75.0 MB |
| **Net LOC root -> mid** | 164 896 |
| **Net LOC mid -> HEAD** | 360 071 |
| **Binary delta root -> mid** | 20.1 MB |
| **Binary delta mid -> HEAD** | 57.0 MB |
| **bytes/line root -> mid** | 127.7 |
| **bytes/line mid -> HEAD** | 166.0 |

Репозиторий сильно вырос от нескольких файлов в первом коммите до более чем 2 тысяч файлов на момент HEAD. В среднем каждая строка в итоговом диффе root -> HEAD условно "переписывалась" примерно 1.67 раза.

### Третья точка (середина истории)

Статистика только root -> HEAD вырождена: многие файлы в root отсутствовали (SIZE FIRST = 0), поэтому binary delta для них совпадает с текущим размером. Поэтому программа находит **средний коммит** mid (`9458ca20f392`) и выводит отдельно метрики для root -> mid и mid -> HEAD (см. таблицу выше). В таблице по файлам добавлены колонки **SIZE MID** (размер в mid) и **DELTA MID** (дельта от mid до HEAD). Так можно сравнить соотношение "строки vs байты" на двух отрезках и видеть пофайловую дельту относительно середины истории.

## 3. Top 30 файлов по накопленному ACCUM LOC

Данные соответствуют выводу программы для коммитов root / mid / HEAD, указанных выше. Колонки **SIZE MID** и **DELTA MID** - размер в средней ревизии и дельта от mid до HEAD, **bytes/line** - пофайловое соотношение объёма в байтах к net LOC (root -> HEAD).

| # | Файл | ACCUM | NET | RATIO | SIZE FIRST | SIZE MID | SIZE LAST | DELTA | DELTA MID | B/L |
|---|------|-------|-----|-------|------------|----------|-----------|-------|-----------|---|
| 1 | sky/cli.py | 26 635 | 9 | 2959.44× | 0 B | 213.1 KB | 178 B | 178 B | 212.9 KB | 19.8 |
| 2 | sky/backends/cloud_vm_ray_backend.py | 24 841 | 6 293 | 3.95× | 0 B | 241.7 KB | 298.8 KB | 298.8 KB | 57.1 KB | 48.6 |
| 3 | sky/dashboard/package-lock.json | 24 547 | 15 453 | 1.59× | 0 B | 0 | 556.2 KB | 556.2 KB | 556.2 KB | 36.9 |
| 4 | tests/test_smoke.py | 17 426 | 42 | 414.90× | 0 B | 1.0 KB | 1.3 KB | 1.3 KB | 265 B | 31.4 |
| 5 | sky/backends/backend_utils.py | 15 356 | 4 118 | 3.73× | 0 B | 130.1 KB | 183.6 KB | 183.6 KB | 53.5 KB | 45.7 |
| 6 | llm/vicuna/dummy.json | 11 840 | 11 840 | 1.00× | 0 B | 266.2 KB | 266.2 KB | 266.2 KB | 0 | 23.0 |
| 7 | sky/data/storage.py | 11 727 | 4 763 | 2.46× | 0 B | 202.3 KB | 212.2 KB | 212.2 KB | 9.9 KB | 45.6 |
| 8 | sky/client/cli/command.py | 10 040 | 7 528 | 1.33× | 0 B | 0 | 291.7 KB | 291.7 KB | 291.7 KB | 39.7 |
| 9 | sky/jobs/state.py | 9 495 | 3 125 | 3.04× | 0 B | 42.5 KB | 128.0 KB | 128.0 KB | 85.5 KB | 41.9 |
| 10 | sky/dashboard/src/components/jobs.jsx | 7 698 | 2 816 | 2.73× | 0 B | 0 | 92.1 KB | 92.1 KB | 92.1 KB | 33.5 |
| 11 | sky/global_user_state.py | 7 195 | 3 009 | 2.39× | 0 B | 32.5 KB | 114.2 KB | 114.2 KB | 81.7 KB | 38.9 |
| 12 | sky/provision/kubernetes/utils.py | 7 159 | 4 117 | 1.74× | 0 B | 106.9 KB | 166.3 KB | 166.3 KB | 59.4 KB | 41.4 |
| 13 | sky/dashboard/src/components/infra.jsx | 6 316 | 3 368 | 1.88× | 0 B | 0 | 122.6 KB | 122.6 KB | 122.6 KB | 37.3 |
| 14 | sky/jobs/controller.py | 6 036 | 2 066 | 2.92× | 0 B | 28.9 KB | 93.6 KB | 93.6 KB | 64.7 KB | 46.4 |
| 15 | sky/dashboard/src/components/users.jsx | 5 547 | 3 237 | 1.71× | 0 B | 0 | 117.4 KB | 117.4 KB | 117.4 KB | 37.2 |
| 16 | sky/jobs/utils.py | 5 433 | 2 627 | 2.07× | 0 B | 51.3 KB | 114.1 KB | 114.1 KB | 62.7 KB | 44.5 |
| 17 | sky/resources.py | 5 177 | 2 675 | 1.94× | 0 B | 70.5 KB | 114.1 KB | 114.1 KB | 43.7 KB | 43.7 |
| 18 | charts/skypilot/manifests/api-server-overview.json | 4 758 | 2 806 | 1.70× | 0 B | 0 | 68.4 KB | 68.4 KB | 68.4 KB | 25.0 |
| 19 | sky/server/server.py | 4 746 | 2 922 | 1.62× | 0 B | 41.4 KB | 118.9 KB | 118.9 KB | 77.4 KB | 41.7 |
| 20 | tests/smoke_tests/test_cluster_job.py | 4 692 | 3 154 | 1.49× | 0 B | 85.1 KB | 148.6 KB | 148.6 KB | 63.5 KB | 48.3 |
| 21 | sky/provision/kubernetes/instance.py | 4 604 | 2 226 | 2.07× | 0 B | 49.3 KB | 97.3 KB | 97.3 KB | 48.0 KB | 44.8 |
| 22 | sky/client/sdk.py | 4 568 | 3 030 | 1.51× | 0 B | 65.4 KB | 117.0 KB | 117.0 KB | 51.6 KB | 39.5 |
| 23 | sky/core.py | 4 327 | 1 717 | 2.52× | 0 B | 44.4 KB | 70.5 KB | 70.5 KB | 26.0 KB | 42.0 |
| 24 | sky/task.py | 4 130 | 1 890 | 2.19× | 0 B | 53.7 KB | 79.7 KB | 79.7 KB | 26.0 KB | 43.2 |
| 25 | tests/unit_tests/test_sky/clouds/test_kubernetes.py | 3 970 | 3 174 | 1.25× | 0 B | 0 | 136.7 KB | 136.7 KB | 136.7 KB | 44.1 |
| 26 | docs/source/getting-started/installation.rst | 3 936 | 1 718 | 2.29× | 0 B | 22.2 KB | 52.4 KB | 52.4 KB | 30.2 KB | 31.2 |
| 27 | sky/dashboard/src/pages/jobs/[job].js | 3 919 | 1 577 | 2.49× | 0 B | 0 | 58.6 KB | 58.6 KB | 58.6 KB | 38.1 |
| 28 | sky/clouds/gcp.py | 3 878 | 1 542 | 2.51× | 0 B | 53.9 KB | 67.8 KB | 67.8 KB | 14.0 KB | 45.0 |
| 29 | sky/dashboard/src/components/clusters.jsx | 3 804 | 1 708 | 2.23× | 0 B | 0 | 49.0 KB | 49.0 KB | 49.0 KB | 29.4 |
| 30 | sky/clouds/aws.py | 3 794 | 1 684 | 2.25× | 0 B | 52.8 KB | 74.2 KB | 74.2 KB | 21.4 KB | 45.1 |

---

## 4. Агрегация по директориям

Информация по директориям также представляет интерес, вот таблица по директориям из корня репозитория:

| Директория | Файлов | ACCUM LOC | NET LOC | RATIO | BIN DELTA |
|------------|--------|-----------|---------|-------|-----------|
| sky/ | 738 | 478 659 | 251 185 | 1.91× | 10.1 MB |
| tests/ | 411 | 154 294 | 113 024 | 1.37× | 4.3 MB |
| docs/ | 361 | 62 955 | 35 189 | 1.79× | 27.2 MB |
| llm/ | 194 | 38 006 | 35 260 | 1.08× | 1.1 MB |
| examples/ | 321 | 23 282 | 19 404 | 1.20× | 31.7 MB |
| charts/ | 41 | 15 239 | 10 281 | 1.48× | 318.6 KB |
| (root) | 19 | 6 027 | 2 564 | 2.35× | 98.5 KB |
| .github/ | 31 | 5 842 | 3 194 | 1.83× | 126.6 KB |
| .buildkite/ | 2 | 1 322 | 788 | 1.68× | 30.2 KB |
| addons/ | 13 | 956 | 924 | 1.03× | 28.5 KB |
| sky_templates/ | 5 | 286 | 268 | 1.07× | 9.2 KB |
| .cursor/ | 1 | 8 | 8 | 1.00× | 248 B |

---

## 5. Интерпретация

### Пофайловая разница: построчный diff и объём в байтах

По каждому файлу считается **bytes/line** = binary delta / net LOC - сколько байт в среднем приходится на одну изменённую строку в диффе root -> HEAD. Программа выводит:

1. Колонку **bytes/line** в таблице top-файлов по accum LOC.
2. Отдельный блок **"per-file: byte delta vs net LOC"** - топ файлов, отсортированных по убыванию bytes/line (файлы с маленьким net LOC и большим бинарным дельтой дают высокий B/L, файлы с "длинными" строками или бинарными фрагментами тоже).

Так можно увидеть, где метрика "изменённые строки" плохо отражает фактический объём правок в байтах (например, JSON).

### Соотношение LOC-changed и binary delta

- **Accumulated LOC** (786 876) - суммарный "объём правок" в строках по всей истории.
- **Net LOC** (472 089) - объём изменений в одном диффе root -> HEAD.
- **Binary delta** (75 MB) - прирост размера файлов между root и HEAD (новые файлы в root дают SIZE FIRST = 0).
- **DELTA MID** - показывает изменение размера от средней точки до HEAD: для файлов, уже существовавших в mid, это невырожденная дельта (например, `cloud_vm_ray_backend.py`: 241.7 KB -> 298.8 KB, delta_mid 57.1 KB).

Общий ratio 1.67× означает, что в среднем строки переписывались чуть больше одного раза; при этом по отдельным файлам разброс большой.

### Наиболее "шумные" файлы

- **sky/cli.py** - ratio 2959×: в mid был 213.1 KB, в HEAD 178 B (delta_mid 212.9 KB), файл многократно переписывали/рефакторили, в итоге осталось мало кода.
- **tests/test_smoke.py** - ratio 414×: типичный тестовый файл с частыми изменениями при небольшом итоговом размере.
- **sky/backends/cloud_vm_ray_backend.py**, **backend_utils.py**, **sky/jobs/state.py** - ratio 3–4×: видно, что являются довольно важными файлами, значительный показатель при существенном текущем размере.

### Директории

- **sky/** - основной код: наибольший accum LOC (478k) и net LOC (251k), binary delta 10.1 MB; ratio 1.91×.
- **tests/** - много изменений (154k accum LOC), ratio 1.37×, что ближе к добавлению без частого переписывания, что в целом ожидаемо для тестов.
- **docs/** - ratio 1.79× при большом binary delta (27.2 MB): достаточно тяжелая папка, впрочем неудивительно, поскольку там лежит много картинок. Скорее всего часто менялся текст.
- **examples/** - самый большой binary delta (31.7 MB) при умеренном LOC: скорее всего в директорию в основном добавляли новое, без особых изменений в дальнейшем.
- **llm/**, **addons/**, **sky_templates/** - ratio около 1.0×: изменения ближе к "одноразовому" добавлению.

### Вывод

Статистика подтверждает различие между "объёмом правок в истории" (accum LOC) и "итоговым изменением между первой и последней версией" (net LOC и binary delta). Пофайловая метрика bytes/line показывает, где построчный diff адекватно отражает объём изменений в байтах, а где нет. Третья точка (середина истории) даёт невырожденные сравнения root -> mid и mid -> HEAD вместо одного только root -> HEAD. Файлы с очень высоким ratio - кандидаты на рефакторинг или нестабильные точки входа (CLI, smoke-тесты), директории с большим binary delta при умеренном ratio - в основном рост за счёт нового контента (документация, примеры).

