# Динамика данных vs строк (LOC) в файлах

Для отслеживания динамики данных и строк в файлах, была написана программа на Go, код которой лежит в [main.go](./main.go). В качестве примера использования программы был выбран репозиторий [skypilot-org/skypilot](https://github.com/skypilot-org/skypilot).

## 1. Постановка задачи

Оригинальный текст задачи:

    Track the dynamic of data changed vs lines changed in files, make stats (accumulation of loc-changed vs actual binary diff of first and last versions)

Какие данные нужно получить:

- **Accumulation of LOC-changed** - накопленная по всей истории сумма изменённых строк (добавлено + удалено) по каждому файлу.
- **Actual binary diff of first and last versions** - объём отличий между первой и последней версией разница размеров в байтах: `|size(HEAD) − size(root)|`.

Также посчитаем **net LOC** (дифф root -> HEAD в строках) и **ratio** = accum LOC / net LOC - соотношение изменений к измененным строкам, количество изменений на одну строку.

## 2. Сводные показатели

Запустив программу получим следующую информацию:

| Показатель | Значение |
|------------|----------|
| Файлов в корневом коммите | 6 |
| Файлов в HEAD | 2 137 |
| **Total accumulated LOC changed** | 786 876 |
| **Total net LOC (root → HEAD)** | 472 089 |
| **Overall accumulation ratio** | 1.67× |
| **Total binary delta** | 75.0 MB |

Заметно, что репозиторий сильно вырос от 6 файлов в первом коммите до более чем 2 тысяч файлов на момент рассмотрения*. В среднем каждая строка в итоговом диффе условно "переписывалась" примерно 1.67 раза.

---

\* последний коммит на момент которого была запущена программа: https://github.com/skypilot-org/skypilot/tree/0fcf3e8c110321421ac86ada11dab4a7e462c648

## 3. Top 30 файлов по накопленному ACCUM LOC

Также можно посмотреть статистику по файлам, что позволяет заметить вероятнее всего самые важные файлы, которые чаще и больше всего менялись:

| # | Файл | ACCUM LOC | NET LOC | RATIO | SIZE FIRST | SIZE LAST | BIN DELTA |
|---|------|-----------|---------|-------|------------|-----------|-----------|
| 1 | sky/cli.py | 26 635 | 9 | 2959.44× | 0 B | 178 B | 178 B |
| 2 | sky/backends/cloud_vm_ray_backend.py | 24 841 | 6 293 | 3.95× | 0 B | 298.8 KB | 298.8 KB |
| 3 | sky/dashboard/package-lock.json | 24 547 | 15 453 | 1.59× | 0 B | 556.2 KB | 556.2 KB |
| 4 | tests/test_smoke.py | 17 426 | 42 | 414.90× | 0 B | 1.3 KB | 1.3 KB |
| 5 | sky/backends/backend_utils.py | 15 356 | 4 118 | 3.73× | 0 B | 183.6 KB | 183.6 KB |
| 6 | llm/vicuna/dummy.json | 11 840 | 11 840 | 1.00× | 0 B | 266.2 KB | 266.2 KB |
| 7 | sky/data/storage.py | 11 727 | 4 763 | 2.46× | 0 B | 212.2 KB | 212.2 KB |
| 8 | sky/client/cli/command.py | 10 040 | 7 528 | 1.33× | 0 B | 291.7 KB | 291.7 KB |
| 9 | sky/jobs/state.py | 9 495 | 3 125 | 3.04× | 0 B | 128.0 KB | 128.0 KB |
| 10 | sky/dashboard/src/components/jobs.jsx | 7 698 | 2 816 | 2.73× | 0 B | 92.1 KB | 92.1 KB |
| 11 | sky/global_user_state.py | 7 195 | 3 009 | 2.39× | 0 B | 114.2 KB | 114.2 KB |
| 12 | sky/provision/kubernetes/utils.py | 7 159 | 4 117 | 1.74× | 0 B | 166.3 KB | 166.3 KB |
| 13 | sky/dashboard/src/components/infra.jsx | 6 316 | 3 368 | 1.88× | 0 B | 122.6 KB | 122.6 KB |
| 14 | sky/jobs/controller.py | 6 036 | 2 066 | 2.92× | 0 B | 93.6 KB | 93.6 KB |
| 15 | sky/dashboard/src/components/users.jsx | 5 547 | 3 237 | 1.71× | 0 B | 117.4 KB | 117.4 KB |
| 16 | sky/jobs/utils.py | 5 433 | 2 627 | 2.07× | 0 B | 114.1 KB | 114.1 KB |
| 17 | sky/resources.py | 5 177 | 2 675 | 1.94× | 0 B | 114.1 KB | 114.1 KB |
| 18 | charts/skypilot/manifests/api-server-overview.json | 4 758 | 2 806 | 1.70× | 0 B | 68.4 KB | 68.4 KB |
| 19 | sky/server/server.py | 4 746 | 2 922 | 1.62× | 0 B | 118.9 KB | 118.9 KB |
| 20 | tests/smoke_tests/test_cluster_job.py | 4 692 | 3 154 | 1.49× | 0 B | 148.6 KB | 148.6 KB |
| 21 | sky/provision/kubernetes/instance.py | 4 604 | 2 226 | 2.07× | 0 B | 97.3 KB | 97.3 KB |
| 22 | sky/client/sdk.py | 4 568 | 3 030 | 1.51× | 0 B | 117.0 KB | 117.0 KB |
| 23 | sky/core.py | 4 327 | 1 717 | 2.52× | 0 B | 70.5 KB | 70.5 KB |
| 24 | sky/task.py | 4 130 | 1 890 | 2.19× | 0 B | 79.7 KB | 79.7 KB |
| 25 | tests/unit_tests/test_sky/clouds/test_kubernetes.py | 3 970 | 3 174 | 1.25× | 0 B | 136.7 KB | 136.7 KB |
| 26 | docs/source/getting-started/installation.rst | 3 936 | 1 718 | 2.29× | 0 B | 52.4 KB | 52.4 KB |
| 27 | sky/dashboard/src/pages/jobs/[job].js | 3 919 | 1 577 | 2.49× | 0 B | 58.6 KB | 58.6 KB |
| 28 | sky/clouds/gcp.py | 3 878 | 1 542 | 2.51× | 0 B | 67.8 KB | 67.8 KB |
| 29 | sky/dashboard/src/components/clusters.jsx | 3 804 | 1 708 | 2.23× | 0 B | 49.0 KB | 49.0 KB |
| 30 | sky/clouds/aws.py | 3 794 | 1 684 | 2.25× | 0 B | 74.2 KB | 74.2 KB |

---

## 4. Агрегация по директориям

Информация по директориям также представляет интерес, вот таблица по директориям из корня репозитория:

| Директория | Файлов | ACCUM LOC | NET LOC | RATIO | BIN DELTA |
|------------|--------|-----------|---------|-------|-----------|
| sky/ | 738 | 478 659 | 251 185 | 1.91× | 10.1 MB |
| tests/ | 411 | 154 294 | 113 024 | 1.37× | 4.3 MB |
| docs/ | 361 | 62 955 | 35 189 | 1.79× | 27.2 MB |
| llm/ | 194 | 38 006 | 35 260 | 1.08× | 1.1 MB |
| examples/ | 321 | 23 282 | 19 404 | 1.20× | 31.7 MB |
| charts/ | 41 | 15 239 | 10 281 | 1.48× | 318.6 KB |
| (root) | 19 | 6 027 | 2 564 | 2.35× | 98.5 KB |
| .github/ | 31 | 5 842 | 3 194 | 1.83× | 126.6 KB |
| .buildkite/ | 2 | 1 322 | 788 | 1.68× | 30.2 KB |
| addons/ | 13 | 956 | 924 | 1.03× | 28.5 KB |
| sky_templates/ | 5 | 286 | 268 | 1.07× | 9.2 KB |
| .cursor/ | 1 | 8 | 8 | 1.00× | 248 B |

---

## 5. Интерпретация

### Соотношение LOC-changed и binary delta

- **Accumulated LOC** (786 876) отражает суммарный "объём правок" в строках по всей истории.
- **Net LOC** (472 089) - объём изменений в одном диффе между первой и последней версией.
- **Binary delta** (75 MB) - прирост размера файлов между root и HEAD (новые файлы в root дают SIZE FIRST = 0, поэтому BIN DELTA для них равен текущему размеру).

Общий ratio 1.67× означает, что в среднем строки переписывались чуть больше одного раза; при этом по отдельным файлам разброс большой.

### Наиболее "шумные" файлы

- **sky/cli.py** - ratio 2959×: 9 net LOC, 178 B судя по всему файл многократно переписывали/рефакторили, в итоге осталось мало кода.
- **tests/test_smoke.py** - ratio 414×: типичный тестовый файл с частыми изменениями при небольшом итоговом размере.
- **sky/backends/cloud_vm_ray_backend.py**, **backend_utils.py**, **sky/jobs/state.py** - ratio 3–4×: видно, что являются довольно важными файлами, значительный показатель при существенном текущем размере.

### Директории

- **sky/** - основной код: наибольший accum LOC (478k) и net LOC (251k), binary delta 10.1 MB; ratio 1.91×.
- **tests/** - много изменений (154k accum LOC), ratio 1.37×, что ближе к добавлению без частого переписывания, что в целом ожидаемо для тестов.
- **docs/** - ratio 1.79× при большом binary delta (27.2 MB): достаточно тяжелая папка, впрочем неудивительно, поскольку там лежит много картинок. Скорее всего часто менялся текст.
- **examples/** - самый большой binary delta (31.7 MB) при умеренном LOC: скорее всего в директорию в основном добавляли новое, без особых изменений в дальнейшем.
- **llm/**, **addons/**, **sky_templates/** - ratio около 1.0×: изменения ближе к "одноразовому" добавлению.

### Вывод

Статистика подтверждает различие между "объёмом правок в истории" (accum LOC) и "итоговым изменением между первой и последней версией" (net LOC и binary delta). Файлы с очень высоким ratio - кандидаты на рефакторинг или нестабильные точки входа (CLI, smoke-тесты); директории с большим binary delta при умеренном ratio - в основном рост за счёт нового контента (документация, примеры).

