# Merge-конфликты в Linux kernel

Задача — посчитать, как часто в ядре Linux возникают merge-конфликты, и разобраться, что с этим делать.

## Скрипт

`conflict_rate.sh` принимает путь к репозиторию и диапазон дат. Проходит по всем merge-коммитам за этот период, для каждого прогоняет `git merge-tree` (слияние без рабочего дерева) и смотрит, есть ли в выводе маркеры конфликта. В конце печатает статистику.

```bash
git clone --filter=blob:none https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git ./linux-kernel
./conflict_rate.sh ./linux-kernel 2025-01-20 2025-01-26
```

## Результаты

Прогнал на 7 неделях — брал и нагруженные merge window, и спокойный rc-период:

| Период                  | Фаза                | Мержей | Конфликтов | Доля  |
|-------------------------|---------------------|--------|------------|-------|
| 23–29 сен 2024          | merge window v6.12  | 113    | 3          | 2.65% |
| 25 ноя – 1 дек 2024    | merge window v6.13  | 152    | 5          | 3.29% |
| 16–22 дек 2024          | rc-период v6.13     | 117    | 0          | 0.00% |
| 20–26 янв 2025          | merge window v6.14  | 216    | 4          | 1.85% |
| 27 янв – 2 фев 2025    | merge window v6.14  | 93     | 2          | 2.15% |
| 24–30 мар 2025          | merge window v6.15  | 273    | 3          | 1.10% |
| 26 мая – 1 июн 2025    | merge window v6.16  | 210    | 2          | 0.95% |

Всего 1174 мержа, из них 19 с конфликтами — **1.62%**.

Почему так мало? Потому что в ядре конфликты разруливаются ещё на уровне подсистем — мейнтейнеры чинят всё у себя, прежде чем отправить pull request Торвальдсу. Если убрать эту иерархию и сливать всё напрямую, процент вырос бы примерно до 19%. В rc-период конфликтов нет вообще — там принимают только мелкие фиксы, которые друг с другом не пересекаются.

## Рекомендации

### Процесс

- **Иерархия мержей.** Не вливать всё напрямую в main. Пусть ответственные за модули сначала собирают изменения у себя, решают конфликты, и только потом шлют PR. Именно так ядро Linux снижает конфликты с ~19% до ~1.6%.

- **Интеграционная ветка.** Каждый день автоматом сливать туда все активные ветки. Конфликт всплывёт сразу, а не когда разработчик через неделю попытается замержиться. В Linux для этого есть linux-next.

- **Короткие ветки.** Чем дольше ветка живёт отдельно, тем сильнее она расходится с main. Мержить почаще маленькими кусками лучше, чем копить две недели и потом разгребать.

- **Rebase на main.** Подтягивать основную ветку к себе регулярно, не ждать финального мержа.

### Код

- **Дробить «горячие» файлы.** Если в один файл лезут три команды — он будет конфликтовать. Разбить: отдельный конфиг на модуль, отдельный файл маршрутов, отдельные константы.

- **CODEOWNERS.** Закрепить за каждой директорией владельца. Когда у файла один ответственный — два человека одновременно его не трогают.

- **Меньше глобального состояния.** Общие enum-ы, монолитные конфиги, god-объекты — всё это точки, где пересекаются правки разных людей.

### Привычки

- **Мелкие коммиты.** Один коммит — одно изменение. Трогает меньше файлов — меньше шанс на конфликт. Рефакторинг отдельно, фичи отдельно.

- **Форматирование — отдельным коммитом.** Прогнать автоформатер и закоммитить, договорившись с командой. Иначе prettify-коммит конфликтует вообще со всеми ветками.

- **Проверка в CI.** Добавить `git merge-tree` в пайплайн — пусть CI предупреждает о конфликтах при создании PR, до того как разработчик столкнётся с ними руками.
